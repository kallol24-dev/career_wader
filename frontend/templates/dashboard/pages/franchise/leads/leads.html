<!-- HTML -->
 {% extends 'dashboard/layouts/dashboard_layout.html' %}
 {% block content %}


<!-- Bootstrap Modal -->
<div class="modal fade" id="createLeadModal" tabindex="-1" aria-labelledby="createLeadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createLeadModalLabel">Create Lead</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="leadForm">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="leadTitle" class="form-label">Lead Title</label>
              <input type="text" class="form-control" id="leadTitle" name="lead_title" required />
            </div>
            <div class="col-md-4 mb-3">
              <label for="progressStatus" class="form-label">Progress Status</label>
              <input type="text" class="form-control" id="progressStatus" name="progress_status" required />
            </div>
            <div class="col-md-4 mb-3">
              <label for="state" class="form-label">State</label>
              <select class="form-select" id="state" name="state" required>
                <option value="" disabled selected>Select State</option>
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option>
                <option value="Bihar">Meghalaya</option>
                <option value="Chhattisgarh">Chhattisgarh</option>
                <option value="Goa">Goa</option>
                <option value="Gujarat">Gujarat</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="city" class="form-label">City</label>
              <input type="text" class="form-control" id="city" name="city" required />
            </div>
            <div class="col-md-4 mb-3">
              <label for="source" class="form-label">Source</label>
              <select class="form-select" id="source" name="source" required>
                <option value="" disabled selected>Select Source</option>
                <option value="Website">Website</option>
                <option value="Social Media">Social Media</option>
                <option value="Referral">Referral</option>
                <option value="Advertisement">Advertisement</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="interestedService" class="form-label">Interested Service</label>
              <select class="form-select" id="interestedService" name="interested_service" required>
                <option value="" disabled selected>Select Service</option>
                <option value="Career Counseling">Career Counseling</option>
                <option value="Interview Assistance">Interview Assistance</option>
                <option value="Study Abroad">Study Abroad</option>
                <option value="Education Loan">Education Loan</option>
                <option value="Resume Building">Resume Building</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="status" class="form-label">Status</label>
              <select class="form-select" id="status" name="status" required>
                <option value="" disabled selected>Select Status</option>
                <option value="NOT INTERESTED">Not Interested</option>
                <option value="INTERESTED">Interested</option>
                <option value="PENDING">Pending</option>
                <option value="COMPLETED">Completed</option>
                <option value="FOLLOW UP">Follow Up</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="followUpDate" class="form-label">Follow Up Date</label>
              <input type="date" class="form-control" id="followUpDate" name="follow_up_dates" />
            </div>
            <div class="col-md-4 mb-3">
              <label for="comments" class="form-label">Comments</label>
              <textarea class="form-control" id="comments" name="comments" rows="2"></textarea>
            </div>
            <div class="col-md-12 mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea class="form-control" id="description" name="description" rows="3" maxlength="150"></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label for="notes" class="form-label">Notes (Admin Only)</label>
              <textarea class="form-control" id="notes" name="notes" rows="3" readonly></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label for="remarks" class="form-label">Remarks (Admin Only)</label>
              <textarea class="form-control" id="remarks" name="remarks" rows="3" readonly></textarea>
            </div>
          </div>
          <div class="text-end">
            <button type="submit" class="btn btn-success">Create Lead</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

          <div class="container">
            <div class="card">
              <div class="card-body">
                <!-- Trigger Button -->
                        <div class="text-end mb-3">
                          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createLeadModal">
                            + Create Lead
                          </button>
                        </div>
                <!-- Leads Table -->
          <div class="mt-5">
            <h5>Leads Table</h5>
            <div class="text-end mb-3">
              
              <button id="compileExcelBtn" class="btn btn-success mt-3">Compile to Excel</button>
            <div class="mt-3 d-none" id="excelFileContainer">
              <p><strong>Generated File:</strong> lead_compiled.xlsx</p>
              <button id="downloadExcelBtn" class="btn btn-info">Download Excel</button>
              {% comment %} <button id="viewExcelBtn" class="btn btn-info">View Excel</button> {% endcomment %}
              <button id="submitToAdminBtn" class="btn btn-warning">Submit to Admin</button>
              
            </div>
            </div>
          </div>
            <div class="table-responsive">
              <table class="table table-bordered" id="leadTable">
                <thead>
                  <tr id="leadTableHead"></tr>
                </thead>
                <tbody id="leadTableBody"></tbody>
              </table>
            </div>
            {% comment %} <button id="compileExcelBtn" class="btn btn-success mt-3">Compile to Excel</button>
            <div class="mt-3 d-none" id="excelFileContainer">
              <p><strong>Generated File:</strong> lead_compiled.xlsx</p>
              <button id="downloadExcelBtn" class="btn btn-info">Download Excel</button>
              <button id="submitToAdminBtn" class="btn btn-warning">Submit to Admin</button>
              <iframe id="excelIframe" class="mt-3" style="width:100%; height:400px; display:none; border: 1px solid #ccc;"></iframe>
            </div> {% endcomment %}
          </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  let leadsData = [];

  function renderTable() {
    const head = $('#leadTableHead');
    const body = $('#leadTableBody');
    head.empty();
    body.empty();

    if (leadsData.length === 0) return;

    const headers = Object.keys(leadsData[0]).filter(k => k !== 'csrfmiddlewaretoken' && k !== 'id' && k !== 'created_at' && k !== 'updated_at' && k!== 'user');
    headers.forEach(h => head.append(`<th>${h}</th>`));
    leadsData.forEach(lead => {
      let row = '<tr>';
      headers.forEach(h => row += `<td>${lead[h] || ''}</td>`);
      row += '</tr>';
      body.append(row);
    });
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function fetchLeads() {
    const token = getCookie('access_token');
    $.ajax({
      url: 'http://127.0.0.1:8001/api/franchise/leads/',
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token },
      success: function (data) {
        console.log('Fetched leads:', data);
        //leadsData = data.filter(lead => typeof lead === 'object');  // safety check
        leadsData = data.results || [];
        renderTable();
      },
      error: function () {
        Swal.fire('Error', 'Failed to load leads.', 'error');
      }
    });
  }

  $(document).ready(function () {
    let compiledExcelBlob = null;
    const token = getCookie('access_token');

    // Load leads from backend
    fetchLeads();

    $('#leadForm').on('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);

      $.ajax({
        url: 'http://127.0.0.1:8001/api/franchise/lead/post/',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: { 'Authorization': 'Bearer ' + token },
        success: function () {
          Swal.fire('Success', 'Lead created!', 'success');
          $('#leadForm')[0].reset();
          fetchLeads(); // Reload data from DB after submission

          $('#createLeadModal').modal('hide');
        },
        error: function () {
          Swal.fire('Error', 'Failed to create lead.', 'error');
        }
      });
    });

   /* $('#compileExcelBtn').on('click', function () {
      if (!leadsData.length) return alert('No leads to compile.');

      const ws = XLSX.utils.json_to_sheet(leadsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Leads');
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);

      $('#excelFileContainer').removeClass('d-none');
      $('#downloadExcelBtn').off('click').on('click', function () {
        const a = document.createElement('a');
            a.href = url;
            a.download = 'lead_compiled.xlsx';
            a.target = '_blank'; // opens in new tab
            a.click();
      });
    });*/

    $('#compileExcelBtn').on('click', function () {
  if (!leadsData.length) return Swal.fire('No Data', 'No leads to compile.', 'warning');

  // Clear previous content
  $('#excelViewer').remove();
  $('#excelFileContainer').addClass('d-none');
  $('#excelFileContainer').find('#progressBarContainer').remove();

  // Add and show progress bar
  const progressBarHtml = `
    <div id="progressBarContainer" class="mt-3">
      <div class="progress">
        <div id="compileProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          Compiling...
        </div>
      </div>
    </div>`;
  $('#excelFileContainer').before(progressBarHtml);

  // Animate the progress bar manually over 3 seconds
  let progress = 0;
  const interval = setInterval(() => {
    progress += 1;
    $('#compileProgress').css('width', `${progress}%`).attr('aria-valuenow', progress);
    if (progress >= 100) {
      clearInterval(interval);

      // Generate Excel file after progress completes
      //const ws = XLSX.utils.json_to_sheet(leadsData);
      const filteredLeadsData = leadsData.map(({ user, ...rest }) => rest);
      const ws = XLSX.utils.json_to_sheet(filteredLeadsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Leads');
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      compiledExcelBlob  = new Blob([wbout], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });
      const url = URL.createObjectURL(compiledExcelBlob);

      // Show buttons after "compilation"
      $('#excelFileContainer').removeClass('d-none');
      $('#progressBarContainer').remove();

      // Save blob URL for future viewing
      $('#downloadExcelBtn').off('click').on('click', function () {
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lead_compiled.xlsx';
        a.target = '_blank'; // opens in new tab
        a.click();
      });

    }
  }, 30); // 100% in 3s = 3000ms / 100 = 30ms per 1%
});


    $('#submitToAdminBtn').on('click', function () {
  if (!compiledExcelBlob) {
    return Swal.fire('Missing File', 'Please compile the Excel file first.', 'warning');
  }

  const formData = new FormData();
  formData.append('excel_file', compiledExcelBlob, 'lead_compiled.xlsx');

  const token = getCookie('access_token');

  $.ajax({
    url: 'http://127.0.0.1:8001/api/franchise/leads/submit/',
    method: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    headers: { Authorization: 'Bearer ' + token },
    success: function () {
      Swal.fire('Success', 'Submitted to admin and notified.', 'success');
    },
    error: function () {
      Swal.fire('Error', 'Submission failed.', 'error');
    }
  });
});
  });

</script>

 {% endblock %}