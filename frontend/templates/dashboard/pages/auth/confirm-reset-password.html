{% extends "home/layouts/indexbase.html" %}
{% load static %}
{% block content %} 
  <section class="bg-half-170 bg-light d-table w-100">
    <div class="container">
      <div class="row mt-5 justify-content-center">
        <div class="col-lg-12 text-center">
          <div class="pages-heading">
            <h4 class="title mb-0">Reset Password</h4>
          </div>
        </div> <!-- end col -->
      </div>
      <!-- end row -->

      <div class="position-breadcrumb">
        <nav aria-label="breadcrumb" class="d-inline-block">
          <ul class="breadcrumb rounded shadow mb-0 px-4 py-2">
            <li class="breadcrumb-item">
              <a href="#">Page</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Reset Password</li>
          </ul>
        </nav>
      </div>
    </div> <!-- end container -->
  </section>
  <!-- end section -->
  <!-- Hero End -->

  <section class="section">
    <div class="container mt-100 mt-60">
      <div class="row align-items-center">
        <div class="col-lg-6 col-md-6 mt-4 mt-sm-0 pt-2 pt-sm-0 order-2 order-md-1">
          <div class="card custom-form rounded border-0 shadow p-4">
            <div class="app-brand justify-content-center mb-4">
              <a href="{% url 'franchise' %}" class="app-brand-link gap-2"><span class="app-brand-logo demo"><img src="{% static 'home/assets/images/logo-dark.png' %}" alt="Career Wader" /></span></a>
            </div>
            <form id="formResetPassword" class="login-form">
              {% csrf_token %}
              <div class="row">
                <div class="col-lg-12">
                  <div class="mb-3">
                    <label class="form-label">Enter you password <span class="text-danger">*</span></label>
                    <div class="form-icon position-relative">
                      <i data-feather="user" class="fea icon-sm icons"></i>
                      <input type="password" class="form-control ps-5" placeholder="Enter you new password" id="password" name="new_password" autofocus required />
                    </div>
                  </div>
                </div>

                <div class="col-lg-12 mb-0">
                  <div class="d-grid">
                    <button class="btn btn-primary" type="submit">Reset Password</button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    $('#formResetPassword').on('submit', function (e) {
      e.preventDefault()
      const url = new URL(window.location.href);

        // Extract query parameters
      const uid = url.searchParams.get("uid");
      const token = url.searchParams.get("token");
      let formData = $(this).serialize() + `&uid=${uid}&token=${token}`;
    
      axios
        .post(`https://careerwader.in/api/reset-password/`, formData)
        .then(function (response) {
          if( response.status == 200 ){
            $('#formResetPassword')[0].reset()
            Swal.fire({
                title: `Congratulations`,
                text: "Reset password link was sent to your successfully",
                icon: "success",
                confirmButtonText: "OK",
                didClose: () => {
                    // Extra guard to ensure modal is NOT visible after alert closes
                    window.location.replace("https://www.careerwader.in/login/");
                }
            })
          }
        })
        .catch(function (error) {
          const response = error?.response;
          let title = "Something went wrong!";
          let htmlContent = "<ul style='text-align:left;'>";

          if (response && typeof response.data === 'object') {
            for (const [key, value] of Object.entries(response.data)) {
              const message = Array.isArray(value) ? value.join(', ') : value;
              htmlContent += `<li><strong>${key}:</strong> ${message}</li>`;
            }
            htmlContent += "</ul>";
          } else {
            // Fallback error message
            htmlContent = "<p>An unexpected error occurred. Please try again.</p>";
          }

          Swal.fire({
            title: title,
            html: htmlContent,
            icon: "error",
            confirmButtonText: "OK",
          });
        });
        
    })
  </script>
{% endblock %}
