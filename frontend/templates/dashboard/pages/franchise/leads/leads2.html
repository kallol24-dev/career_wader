{% extends 'dashboard/layouts/dashboard_layout.html' %}

{% block content %}
  {% comment %}create a lead form to capture the daily task of the franchise{% endcomment %}
  <div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title">Create Lead</h5>
          </div>
          <div class="card-body">
            <form id="leadForm">
              {% csrf_token %}

              <div class="row">
                <!-- Column 1 -->
                <div class="col-md-4 mb-3">
                  <label for="leadTitle" class="form-label">Lead Title</label>
                  <input type="text" class="form-control" id="leadTitle" name="lead_title" required />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="progressStatus" class="form-label">Progress Status</label>
                  <input type="text" class="form-control" id="progressStatus" name="progress_status" required />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="state" class="form-label">State</label>
                  <select class="form-select" id="state" name="state" required>
                    <option value="" disabled selected>Select State</option>
                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                    <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                    <option value="Assam">Assam</option>
                    <option value="Bihar">Meghalaya</option>
                    <option value="Chhattisgarh">Chhattisgarh</option>
                    <option value="Goa">Goa</option>
                    <option value="Gujarat">Gujarat</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="city" class="form-label">City</label>
                  <input type="text" class="form-control" id="city" name="city" required />
                </div>

                <!-- Column 2 -->
                <div class="col-md-4 mb-3">
                  <label for="source" class="form-label">Source</label>
                  <select class="form-select" id="source" name="source" required>
                    <option value="" disabled selected>Select Source</option>
                    <option value="Website">Website</option>
                    <option value="Social Media">Social Media</option>
                    <option value="Referral">Referral</option>
                    <option value="Advertisement">Advertisement</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="interestedService" class="form-label">Interested Service</label>
                  <select class="form-select" id="interestedService" name="interested_service" required>
                    <option value="" disabled selected>Select Service</option>
                    <option value="Career Counseling">Career Counseling</option>
                    <option value="Interview Assistance">Interview Assistance</option>
                    <option value="Study Abroad">Study Abroad</option>
                    <option value="Education Loan">Education Loan</option>
                    <option value="Resume Building">Resume Building</option>
                    <option value="Other">Other</option>
                  </select>
                </div>

                <!-- Column 3 -->
                <div class="col-md-4 mb-3">
                  <label for="status" class="form-label">Status</label>
                  <select class="form-select" id="status" name="status" required>
                    <option value="" disabled selected>Select Status</option>
                    <option value="NOT INTERESTED">Not Interested</option>
                    <option value="INTERESTED">Interested</option>
                    <option value="PENDING">Pending</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="FOLLOW UP">Follow Up</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="followUpDate" class="form-label">Follow Up Date</label>
                  <input type="date" class="form-control" id="followUpDate" name="follow_up_dates" />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="comments" class="form-label">Comments</label>
                  <textarea class="form-control" id="comments" name="comments" rows="3" maxlength="150"></textarea>
                </div>

                <!-- Full Width (Description, Notes, Remarks) -->
                <div class="col-md-12 mb-3">
                  <label for="description" class="form-label">Description</label>
                  <textarea class="form-control" id="description" name="description" rows="3" maxlength="150"></textarea>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="notes" class="form-label">Notes (Admin Only)</label>
                  <textarea class="form-control" id="notes" name="notes" rows="3" readonly></textarea>
                </div>

                <div class="col-md-6 mb-3">
                  <label for="remarks" class="form-label">Remarks (Admin Only)</label>
                  <textarea class="form-control" id="remarks" name="remarks" rows="3" readonly></textarea>
                </div>
              </div>

               <div class="text-end">
                <button type="submit" class="btn btn-primary">Create Lead</button>
              </div>

            </form>
            <!-- Excel Preview Container -->
              <div id="leadTableContainer" class="mt-5 d-none">
                <h5>Submitted Leads</h5>
                <div class="table-responsive">
                  <table class="table table-bordered" id="leadTable">
                    <thead>
                      <tr id="leadTableHead"></tr>
                    </thead>
                    <tbody id="leadTableBody"></tbody>
                  </table>
                </div>
                <button id="compileLeadsExcelBtn" class="btn btn-success mt-3">Compile Leads</button>
              </div>

              <!-- Compiled File -->
            <div id="compiledFileSection" class="mt-4 d-none">
              <h5>Compiled Excel</h5>
              <div class="d-flex gap-3 align-items-center">
                <span id="compiledFileName">lead_compiled.xlsx</span>
                <button class="btn btn-outline-primary" id="viewCompiledFileBtn">View</button>
                <button class="btn btn-success" id="sendToAdminBtn">Send to Admin</button>
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% comment %} {% block scripts %} {% endcomment %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
  let leads = [];
  let compiledFileBlob = null;
  let compiledFileURL = null;

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function saveLeadsToStorage() {
    localStorage.setItem('submittedLeads', JSON.stringify(leads));
  }

  function loadLeadsFromStorage() {
    const stored = localStorage.getItem('submittedLeads');
    if (stored) {
      leads = JSON.parse(stored);
      if (leads.length > 0) {
        renderLeadTable();
        $('#leadTableContainer').removeClass('d-none');
      }
    }
  }

  function renderLeadTable() {
    const head = $('#leadTableHead');
    const body = $('#leadTableBody');
    head.empty();
    body.empty();

    if (leads.length === 0) return;

    const columns = Object.keys(leads[0]);
    columns.forEach(col => head.append(`<th>${col}</th>`));

    leads.forEach(lead => {
      const row = $('<tr>');
      columns.forEach(col => row.append(`<td>${lead[col] || ''}</td>`));
      body.append(row);
    });
  }

  $(document).ready(function () {
    const token = getCookie('access_token');
    loadLeadsFromStorage();

    $('#leadForm').on('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const leadData = {};
      formData.forEach((value, key) => leadData[key] = value);

      $.ajax({
        url: 'http://127.0.0.1:8001/api/franchise/lead/post/',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: { 'Authorization': 'Bearer ' + token },
        success: function () {
          leads.push(leadData);
          saveLeadsToStorage();
          renderLeadTable();
          $('#leadTableContainer').removeClass('d-none');
          $('#leadForm')[0].reset();
          Swal.fire("Success", "Lead Created!", "success");
        },
        error: function (xhr) {
          Swal.fire("Error", "Failed to create lead.", "error");
          console.error(xhr.responseText);
        }
      });
    });

    $('#compileLeadsExcelBtn').on('click', function () {
      if (leads.length === 0) return;

      const ws = XLSX.utils.json_to_sheet(leads);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Leads");

      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      compiledFileBlob = new Blob([wbout], {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
      });
      compiledFileURL = URL.createObjectURL(compiledFileBlob);

      $('#compiledFileSection').removeClass('d-none');
      Swal.fire("Compiled!", "Excel file is ready.", "success");
    });

    $('#viewCompiledFileBtn').on('click', function () {
      if (compiledFileURL) window.open(compiledFileURL, '_blank');
    });

    $('#sendToAdminBtn').on('click', function () {
      if (!compiledFileBlob) {
        Swal.fire("No File", "Please compile leads first.", "info");
        return;
      }

      const formData = new FormData();
      formData.append('file', compiledFileBlob, 'compiled_leads.xlsx');

      $.ajax({
        url: 'http://127.0.0.1:8001/api/franchise/send-leads-to-admin/',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: { 'Authorization': 'Bearer ' + token },
        success: function () {
          Swal.fire("Sent!", "Leads sent to admin.", "success");
        },
        error: function (xhr) {
          Swal.fire("Error", "Failed to send.", "error");
          console.error(xhr.responseText);
        }
      });
    });
  });
</script>
  {% endblock %}
